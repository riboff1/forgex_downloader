<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ForgeX Downloader</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:#000;color:#fff;overflow-x:hidden;}
canvas#particles{position:fixed;top:0;left:0;z-index:0;}
.container{position:relative;z-index:2;width:90%;max-width:800px;margin:50px auto;}
h1{font-size:26px;color:#00C853;margin-bottom:8px;text-align:center;}
p.subtitle{font-size:16px;color:#bbb;text-align:center;margin-bottom:25px;}
input[type="text"]{width:100%;padding:12px;font-size:14px;color:#fff;background:#1b1b1b;border:1px solid #333;border-radius:10px;outline:none;margin-bottom:40px;}
.file-list{display:flex;flex-direction:column;gap:30px;}
.file-item{background:linear-gradient(180deg,rgba(30,30,30,0.9),rgba(10,10,10,0.8));border:1px solid rgba(0,255,100,0.1);backdrop-filter:blur(12px);border-radius:15px;overflow:hidden;box-shadow:0 6px 20px rgba(0,255,100,0.05);transition:0.3s ease;}
.file-item:hover{transform:translateY(-4px);background:linear-gradient(180deg,rgba(35,35,35,0.95),rgba(15,15,15,0.9));border-color:rgba(0,255,100,0.3);box-shadow:0 8px 25px rgba(0,255,100,0.1);}
.file-thumb{width:100%;height:150px;object-fit:cover;display:none;}
.file-item.has-thumb .file-thumb{display:block;}
.file-title{font-size:17px;font-weight:600;color:#fff;padding:10px 14px 0 14px;}
.file-description{font-size:13px;color:#cfcfcf;padding:4px 14px 10px 14px;}
.download-btn{width:calc(100% - 24px);margin:10px 12px 12px 12px;padding:10px;border:none;border-radius:8px;background:linear-gradient(135deg,#00C853,#00E676);color:#fff;font-size:15px;font-weight:600;cursor:pointer;transition:background 0.2s ease;}
.download-btn:hover{background:linear-gradient(135deg,#00E676,#00C853);box-shadow:0 4px 10px rgba(0,255,100,0.4);}
.unlock-btn{width:calc(100% - 24px);margin:10px 12px 12px 12px;padding:10px;border:none;border-radius:8px;background:linear-gradient(135deg,#FF6D00,#FF9100);color:#fff;font-size:15px;font-weight:600;cursor:pointer;transition:background 0.2s ease;}
.unlock-btn:hover{background:linear-gradient(135deg,#FF9100,#FF6D00);box-shadow:0 4px 10px rgba(255,140,0,0.4);}
</style>
</head>
<body>
<canvas id="particles"></canvas>
<div class="container">
  <h1>ForgeX Downloader</h1>
  <p class="subtitle">Download your files</p>
  <input type="text" id="searchInput" placeholder="Search files...">
  <div class="file-list" id="fileList">Loading files...</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, child, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

document.addEventListener("DOMContentLoaded", async ()=>{
  const firebaseConfig = {
    apiKey: "AIzaSyCruAGS_S2sVx6C7qtDHVghxCZJaCe9JCY",
    authDomain: "forgex-file-downloader.firebaseapp.com",
    databaseURL: "https://forgex-file-downloader-default-rtdb.firebaseio.com",
    projectId: "forgex-file-downloader",
    storageBucket: "forgex-file-downloader.firebasestorage.app",
    messagingSenderId: "643437822919",
    appId: "1:643437822919:web:ce0c90d19e622969f48fe2"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const fileListDiv = document.getElementById("fileList");
  const searchInput = document.getElementById("searchInput");
  let allFiles = [];

  const AES_KEY = "1234567890abcdef";
  const AES_IV  = "abcdef1234567890";

  function encryptAES(data){
      const encrypted = CryptoJS.AES.encrypt(data, CryptoJS.enc.Utf8.parse(AES_KEY), {
          iv: CryptoJS.enc.Utf8.parse(AES_IV),
          mode: CryptoJS.mode.CBC,
          padding: CryptoJS.pad.Pkcs7
      });
      return encrypted.toString().replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }

  async function shortenUrl(longUrl){
      try{
          const apiToken = '430915a5e116e305863de9d5717c3eb61e2c7234';
          const apiUrl = `https://just2earn.com/api?api=${apiToken}&url=${encodeURIComponent(longUrl)}`;
          const response = await fetch(apiUrl);
          const result = await response.json();
          return result.status==='error'?null:result.shortenedUrl;
      }catch(e){ console.error(e); alert('Failed! Please Try Again Later'); return null; }
  }

/*
  window.handleDownload = function(fileUrl){
    window.location.href = fileUrl;
  }
*/

window.handleUnlock = async function(btn, fileUrl, fileTitle, fileSize, fileType, totalUnlocks, childKey) {
  btn.disabled = true;
  const originalText = btn.innerText;
  let currentUrl = fileUrl;

  try {
    for (let i = 1; i <= totalUnlocks; i++) {
      btn.innerText = `Processing... ${i}/${totalUnlocks}`;

      const steps = totalUnlocks - i + 1;

      const rawData = `file_name=${encodeURIComponent(fileTitle)}&file_type=${encodeURIComponent(fileType)}&file_size=${encodeURIComponent(fileSize)}&file_url=${encodeURIComponent(fileUrl)}&unlocks_done=${steps}&unlock_ads=${totalUnlocks}&child_key=${encodeURIComponent(childKey)}`;
      const encryptedKey = encryptAES(rawData);
      const downloadUrl = `https://riboff1.github.io/unlock_file/?key=${encryptedKey}`;

      const shortUrl = await shortenUrl(downloadUrl);

      if (!shortUrl) {
        alert("Error: Failed to process link shortening. Please try again later.");
        btn.disabled = false;
        btn.innerText = originalText;
        return;  // Stop processing on error
      }
      currentUrl = shortUrl;
      fileUrl = shortUrl; // Update original to shortened for next iteration
      await new Promise(res => setTimeout(res, 1000)); // slight delay as before
    }

    // Once all steps done, increment download count and redirect
    const downloadsRef = ref(db, `file_lists/${childKey}/downloads`);
    try {
      await runTransaction(downloadsRef, current => (current || 0) + 1);
    } catch (e) {
      console.error("Failed to increment downloads:", e);
      // proceed anyway
    }
    window.location.href = currentUrl;

  } catch (e) {
    console.error(e);
    alert("Something went wrong. Please try again.");
    btn.disabled = false;
    btn.innerText = originalText;
  }
};
  
window.handleDownload = async function(btn, file_url, child_key) {
  btn.disabled = true;
  const originalText = btn.innerText;
  btn.innerText = "Processing...";

  const downloadsRef = ref(db, `file_lists/${child_key}/downloads`);

  try {
    await runTransaction(downloadsRef, current => (current || 0) + 1);
    window.location.href = file_url;
  } catch (e) {
    console.error("Failed to increment downloads:", e);
    alert("Failed to process your download. Please try again later.");
  } finally {
    btn.disabled = false;
    btn.innerText = originalText;
  }
};

  function renderFiles(files){
      fileListDiv.innerHTML = files.length? "" : "No files available.";
      files.forEach(f=>{
          const div = document.createElement("div");
          div.className = "file-item" + (f.thumb_url?" has-thumb":"");
          if(f.thumb_url) div.innerHTML += `<img src="${f.thumb_url}" class="file-thumb">`;
          div.innerHTML += `<div class="file-title">${f.file_title}</div><div class="file-description">${f.file_description}</div>`;
          const btn = document.createElement("button");
          if(f.unlock_ads>0){
              btn.className = "unlock-btn";
              btn.textContent = `ðŸ” Unlock 0/${f.unlock_ads}`;
              btn.addEventListener("click",()=> window.handleUnlock(btn,f.file_url,f.file_title,f.file_size,f.file_type,f.unlock_ads,f._key));
          }else{
              btn.className = "download-btn";
              btn.textContent = "Download";
              btn.addEventListener("click", () => window.handleDownload(btn, f.file_url, f._key));
          }
          div.appendChild(btn);
          fileListDiv.appendChild(div);
      });
  }

  async function loadFiles(){
    fileListDiv.innerHTML = "Loading files...";
    const snapshot = await get(child(ref(db),"file_lists"));
    allFiles = [];
    if(snapshot.exists()){
        const data = snapshot.val();
        Object.keys(data).forEach(k => {
            const file = data[k];
            file._key = k;      // add the child key
            allFiles.push(file); // push the modified object
        });
        renderFiles(allFiles);
    } else {
        fileListDiv.innerHTML = "No files available.";
    }
 }

  searchInput.addEventListener("input", ()=>{
      const q = searchInput.value.toLowerCase();
      const filtered = allFiles.filter(f=>f.file_title.toLowerCase().includes(q));
      renderFiles(filtered);
  });

  // Particle background
  const canvas=document.getElementById('particles');
  const ctx=canvas.getContext('2d');
  let w,h,particles=[];
  function resize(){ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
  window.addEventListener('resize',resize); resize();
  class Particle{constructor(){this.x=Math.random()*w;this.y=Math.random()*h;this.vx=(Math.random()-0.5)*0.4;this.vy=(Math.random()-0.5)*0.4;this.size=1+Math.random()*1.5;} move(){this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>w)this.vx*=-1; if(this.y<0||this.y>h)this.vy*=-1;}}
  for(let i=0;i<30;i++)particles.push(new Particle());
  function draw(){ ctx.clearRect(0,0,w,h); ctx.fillStyle='#00C853'; ctx.strokeStyle='#00C853';
    for(let p of particles){ p.move(); ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();}
    for(let i=0;i<particles.length;i++){for(let j=i+1;j<particles.length;j++){let dx=particles[i].x-particles[j].x; let dy=particles[i].y-particles[j].y; let dist=Math.sqrt(dx*dx+dy*dy); if(dist<150){ctx.globalAlpha=1-dist/150;ctx.beginPath();ctx.moveTo(particles[i].x,particles[i].y);ctx.lineTo(particles[j].x,particles[j].y);ctx.stroke();ctx.globalAlpha=1;}}} requestAnimationFrame(draw);}
  draw();

  loadFiles();
});
</script>
</body>
</html>
